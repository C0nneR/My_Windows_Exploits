#include<stdio.h>
#include<Windows.h>

int main() {
	HANDLE hProcess;
	HANDLE hToken;
	BOOL bRet = FALSE;
	DWORD dwLen;
	PSID* pSid = NULL;

	hProcess = GetCurrentProcess();
	do {
		bRet = OpenProcessToken(hProcess, TOKEN_QUERY, &hToken);
		if (!bRet) {
			printf("OpenProcessToken failed.\n");
			break;
		}

		bRet = GetTokenInformation(hToken, TokenIntegrityLevel, 0, 0, &dwLen);
		if (!(!bRet && GetLastError() == 122)) {
			printf("GetTokenInformation failed (1).\n");
			break;
		}

		pSid = (PSID*)LocalAlloc(0, dwLen);
		if (NULL == pSid) {
			printf("LocalAlloc failed.\n");
			break;
		}

		bRet = GetTokenInformation(hToken, TokenIntegrityLevel, pSid, dwLen, &dwLen);
		if (!bRet) {
			printf("GetTokenInformation failed (2).\n");
			break;
		}

		PUCHAR pCount = GetSidSubAuthorityCount(*pSid);
		PDWORD pdwRid = GetSidSubAuthority(*pSid, (unsigned char)(*pCount - 1));
		printf("RID: %X\n", *pdwRid);

	} while (FALSE);

	if (NULL != pSid) {
		LocalFree(pSid);
	}
	CloseHandle(hToken);
	CloseHandle(hProcess);
	system("pause");
	return 0;
}