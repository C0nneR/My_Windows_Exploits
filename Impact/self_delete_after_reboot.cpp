#include <stdio.h>
#include <tchar.h>
#include <Windows.h>

BOOL SelfDelete() {
	BOOL bRet = FALSE;
	DWORD dwLen;
	TCHAR szPath[256];
	TCHAR szFinalPath[MAX_PATH] = _T("\\\\?\\");
	memset(szPath, '\0', sizeof(TCHAR) * 256);
	
	dwLen = GetModuleFileName(NULL, szPath, 256);
	lstrcat(szFinalPath, szPath);

	// MOVEFILE_DELAY_UNTIL_REBOOT can be used only if the process
	// is in the context of a user who belongs to the administrators
	// group or the LocalSystem account
	bRet = MoveFileEx(szFinalPath, NULL, MOVEFILE_DELAY_UNTIL_REBOOT);
	return bRet;
}

int main() {
	if (FALSE == SelfDelete()) {
		printf("SelfDelete failed.\n");
	}
	else {
		printf("SelfDelete succeeded. Check after reboot.\n");
	}

	system("pause");
	return 0;
}